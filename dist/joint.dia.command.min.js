/*! Rappid v2.0.0 - HTML5 Diagramming Framework

Copyright (c) 2015 client IO

 2016-09-20 


This Source Code Form is subject to the terms of the Rappid Academic License
, v. 1.0. If a copy of the Rappid License was not distributed with this
file, You can obtain one at http://jointjs.com/license/rappid_academic_v1.txt
 or from the Rappid archive as was distributed by client IO. See the LICENSE file.*/


joint.dia.CommandManager=Backbone.Model.extend({defaults:{cmdBeforeAdd:null,cmdNameRegex:/^(?:add|remove|change:\w+)$/,applyOptionsList:["propertyPath"],revertOptionsList:["propertyPath"]},PREFIX_LENGTH:7,initialize:function(a){_.bindAll(this,"initBatchCommand","storeBatchCommand"),this.graph=a.graph,this.reset(),this.listen()},listen:function(){this.listenTo(this.graph,"all",this.addCommand,this),this.listenTo(this.graph,"batch:start",this.initBatchCommand,this),this.listenTo(this.graph,"batch:stop",this.storeBatchCommand,this)},createCommand:function(a){var b={action:void 0,data:{id:void 0,type:void 0,previous:{},next:{}},batch:a&&a.batch};return b},push:function(a){this.redoStack=[],a.batch?(this.lastCmdIndex=Math.max(this.lastCmdIndex,0),this.trigger("batch",a)):(this.undoStack.push(a),this.trigger("add",a))},addCommand:function(a,b,c,d){if((!d||!d.dry)&&this.get("cmdNameRegex").test(a)&&("function"!=typeof this.get("cmdBeforeAdd")||this.get("cmdBeforeAdd").apply(this,arguments))){var e=void 0;if(this.batchCommand){if(e=this.batchCommand[Math.max(this.lastCmdIndex,0)],this.lastCmdIndex>=0&&(e.data.id!==b.id||e.action!==a)){var f=_.findIndex(this.batchCommand,function(c,d){return c.data.id===b.id&&c.action===a},this);f<0||"add"===a||"remove"===a?e=this.createCommand({batch:!0}):(e=this.batchCommand[f],this.batchCommand.splice(f,1)),this.lastCmdIndex=this.batchCommand.push(e)-1}}else e=this.createCommand({batch:!1});if("add"===a||"remove"===a)return e.action=a,e.data.id=b.id,e.data.type=b.attributes.type,e.data.attributes=_.merge({},b.toJSON()),e.options=d||{},void this.push(e);var g=a.substr(this.PREFIX_LENGTH);e.batch&&e.action||(e.action=a,e.data.id=b.id,e.data.type=b.attributes.type,e.data.previous[g]=_.clone(b.previous(g)),e.options=d||{}),e.data.next[g]=_.clone(b.get(g)),this.push(e)}},initBatchCommand:function(){this.batchCommand?this.batchLevel++:(this.batchCommand=[this.createCommand({batch:!0})],this.lastCmdIndex=-1,this.batchLevel=0)},storeBatchCommand:function(){if(this.batchCommand&&this.batchLevel<=0){var a=this.filterBatchCommand(this.batchCommand);a.length>0&&(this.redoStack=[],this.undoStack.push(a),this.trigger("add",a)),this.batchCommand=null,this.lastCmdIndex=null,this.batchLevel=null}else this.batchCommand&&this.batchLevel>0&&this.batchLevel--},filterBatchCommand:function(a){for(var b=a.slice(),c=[];b.length>0;){var d=b.shift(),e=d.data.id;if(null!=d.action&&null!=e){if("add"===d.action){var f=_.findIndex(b,{action:"remove",data:{id:e}});if(f>=0){b=_.reject(b,function(a,b){return b<=f&&a.data.id===e});continue}}else if("remove"===d.action){var g=_.findIndex(b,{action:"add",data:{id:e}});if(g>=0){b.splice(g,1);continue}}else if(0===d.action.indexOf("change")&&_.isEqual(d.data.previous,d.data.next))continue;c.push(d)}}return c},revertCommand:function(a,b){this.stopListening();var c;c=_.isArray(a)?a:[a];for(var d=c.length-1;d>=0;d--){var e=c[d],f=this.graph.getCell(e.data.id),g=_.extend({commandManager:this.id||this.cid},b,_.pick(e.options,this.get("revertOptionsList")));switch(e.action){case"add":f.remove(g);break;case"remove":this.graph.addCell(e.data.attributes,g);break;default:var h=e.action.substr(this.PREFIX_LENGTH);f.set(h,e.data.previous[h],g)}}this.listen()},applyCommand:function(a,b){this.stopListening();var c;c=_.isArray(a)?a:[a];for(var d=0;d<c.length;d++){var e=c[d],f=this.graph.getCell(e.data.id),g=_.extend({commandManager:this.id||this.cid},b,_.pick(e.options,this.get("applyOptionsList")));switch(e.action){case"add":this.graph.addCell(e.data.attributes,g);break;case"remove":f.remove(g);break;default:var h=e.action.substr(this.PREFIX_LENGTH);f.set(h,e.data.next[h],g)}}this.listen()},undo:function(a){var b=this.undoStack.pop();b&&(this.revertCommand(b,a),this.redoStack.push(b))},redo:function(a){var b=this.redoStack.pop();b&&(this.applyCommand(b,a),this.undoStack.push(b))},cancel:function(a){this.hasUndo()&&(this.revertCommand(this.undoStack.pop(),a),this.redoStack=[])},reset:function(){this.undoStack=[],this.redoStack=[]},hasUndo:function(){return this.undoStack.length>0},hasRedo:function(){return this.redoStack.length>0}});